<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Duolingo 2.0</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Merriweather:wtml@300;400;700&family=Patrick+Hand&display=swap"
    rel="stylesheet">
  <!-- Markdown rendering library -->
  <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
  <style>
    /* CSS Variables for Theme Support */
    :root {
      --bg-primary: #FDFCF7;
      --bg-secondary: #FFFFFF;
      --text-primary: #1C1C1C;
      --text-secondary: #5A5A5A;
      --text-muted: #999999;
      --accent-primary: #2E8B57;
      --accent-secondary: #90EE90;
      --accent-tertiary: rgba(144, 238, 144, 0.95);
      --accent-scrolled: rgba(144, 238, 144, 0.7);
      --shadow-light: rgba(0, 0, 0, 0.08);
      --shadow-medium: rgba(0, 0, 0, 0.15);
      --shadow-dark: rgba(0, 0, 0, 0.3);
      --border-light: rgba(255, 255, 255, 0.3);
      --warning-color: #F77F00;
      --warning-hover: #FFB703;
      --danger-color: #DC143C;
      --danger-hover: #B22222;
      --selection-bg: rgba(255, 183, 3, 0.3);
      --modal-bg: #FFFFFF;
      --input-bg: #FFFFFF;
      --border-color: #ddd;
      --hover-bg: #f5f5f5;
      --secondary-btn-bg: #f8f9fa;
      --text-color: #1C1C1C;
    }

    /* Dark Mode Variables */
    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --text-muted: #808080;
      --accent-primary: #4a9d6a;
      --accent-secondary: #5fb876;
      --accent-tertiary: rgba(74, 157, 106, 0.95);
      --accent-scrolled: rgba(74, 157, 106, 0.8);
      --shadow-light: rgba(255, 255, 255, 0.08);
      --shadow-medium: rgba(255, 255, 255, 0.15);
      --shadow-dark: rgba(0, 0, 0, 0.6);
      --border-light: rgba(0, 0, 0, 0.3);
      --warning-color: #ff8c42;
      --warning-hover: #ffa663;
      --danger-color: #ff6b6b;
      --danger-hover: #ff5252;
      --selection-bg: rgba(255, 183, 3, 0.2);
      --modal-bg: #2d2d2d;
      --input-bg: #3a3a3a;
      --border-color: #555;
      --hover-bg: #404040;
      --secondary-btn-bg: #3a3a3a;
      --text-color: #e0e0e0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Navigation Bar */
    .navbar {
      background-color: var(--accent-tertiary);
      padding: 1rem 2rem;
      box-shadow: 0 2px 8px var(--shadow-light);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1100;
      transition: background-color 0.4s, box-shadow 0.4s;
    }

    .navbar.scrolled {
      background-color: var(--accent-scrolled);
      box-shadow: 0 4px 16px var(--shadow-medium);
    }

    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .nav-left,
    .nav-center,
    .nav-right {
      flex: 1;
      display: flex;
      align-items: center;
    }

    .nav-left {
      justify-content: flex-start;
    }

    .nav-center {
      justify-content: center;
    }

    .nav-right {
      justify-content: flex-end;
    }

    .logo {
      color: white;
      font-family: Arial, sans-serif;
      font-size: 1.6rem;
      font-weight: 700;
    }

    .nav-links {
      display: flex;
      gap: 2rem;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      padding: 1rem 1rem;
      border-radius: 5px;
      transition: all 0.3s;
      font-family: Arial, sans-serif;
      font-weight: 400;
    }

    .nav-link:hover {
      background-color: #FFB703;
      /* Soft accent golden orange */
      color: #1C1C1C;
    }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
      background: none;
      border: 2px solid white;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      cursor: pointer;
      font-family: Arial, sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: 1rem;
    }

    .dark-mode-toggle:hover {
      background-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .dark-mode-toggle .icon {
      font-size: 1rem;
    }

    .nav-link.active {
      background-color: #F77F00;
      /* Bold warm orange */
      color: white;
    }

    /* Main Content */
    .main-content {
      max-width: none;
      margin: 5rem 0 0 0;
      padding: 1.6rem;
      width: 100%;
    }

    /* Page Sections */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* Skill Test Page Styles */
    .skill-test-container {
      background-color: var(--bg-secondary);
      border-radius: 8px;
      padding: 1.6rem;
      box-shadow: 0 4px 6px var(--shadow-light);
      max-width: 600px;
      margin: 0 auto;
    }

    .skill-test-header {
      text-align: center;
      margin-bottom: 1.6rem;
    }

    .skill-test-header h1 {
      color: #2E8B57;
      /* Sea green for headings */
      font-family: Arial, sans-serif;
      font-weight: 700;
      margin-bottom: 0.8rem;
    }

    .skill-test-header p {
      color: #5A5A5A;
      /* Softer gray for secondary text */
      font-size: 1.1rem;
    }

    .question-container {
      margin-bottom: 1.6rem;
    }

    .question {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 1.6rem;
      color: #1C1C1C;
      /* Almost black for primary text */
      font-family: Arial, sans-serif;
    }

    .options-container {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .option {
      display: flex;
      align-items: center;
      padding: 1rem;
      border: 2px solid #E9ECEF;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background-color: white;
    }

    .option:hover {
      border-color: #7B2CBF;
      /* Purple accent */
      background-color: #FFB703;
      /* Soft golden orange background */
    }

    .option.selected {
      border-color: #7B2CBF;
      /* Purple accent */
      background-color: #F77F00;
      /* Bold warm orange */
      color: white;
    }

    .option input[type="radio"] {
      margin-right: 1rem;
      transform: scale(1.2);
    }

    .option label {
      cursor: pointer;
      flex: 1;
      font-size: 1.1rem;
    }

    .test-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 1.6rem;
      padding-top: 1.6rem;
      border-top: 1px solid #dee2e6;
    }

    .btn {
      padding: 0.8rem 1.6rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .btn-primary {
      background-color: var(--accent-primary);
      color: white;
      font-family: Arial, sans-serif;
      font-weight: 400;
    }

    .btn-primary:hover {
      background-color: var(--warning-color);
    }

    .btn:disabled {
      background-color: #e9ecef;
      color: #6c757d;
      cursor: not-allowed;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e9ecef;
      border-radius: 8px;
      margin-bottom: 1.6rem;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: #2E8B57;
      /* Sea green for progress */
      transition: width 0.3s ease;
    }

    /* Chat Page Styles */
    .chat-layout {
      display: flex;
      gap: 1rem;
      min-height: 600px;
      margin: 0;
      padding: 0;
    }

    .story-sidebar {
      width: 320px;
      background-color: var(--bg-secondary);
      border-radius: 0 12px 12px 0;
      padding: 1.6rem;

      border: 2px solid var(--border-color, #ddd);
      border-left: none;
      box-shadow: var(--shadow-medium);
      overflow-y: auto;
      max-height: 90vh;
      position: overlay;
      top: 5rem;
    }

    .sidebar-actions {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      margin-bottom: 1.5rem;
    }

    .sidebar-btn {
      background-color: var(--accent-primary);
      color: white;
      border: none;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: Arial, sans-serif;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .sidebar-btn:hover {
      background-color: var(--accent-secondary);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .story-sidebar h3 {
      margin: 0 0 1.5rem 0;
      color: var(--accent-primary);
      font-family: Arial, sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      text-align: center;
      border-bottom: 2px solid var(--accent-primary);
      padding-bottom: 0.5rem;
    }

    .chat-main {
      flex: 1;
      min-width: 0;
    }

    .chat-container {
      background-color: transparent;
      border-radius: 8px;
      padding: 1.6rem;
      margin-bottom: 1.6rem;
      text-align: center;
    }

    .world-group {
      margin-bottom: 1.5rem;
    }

    .world-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background-color: var(--accent-tertiary);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.3s ease;
      position: relative;
      user-select: none;
      touch-action: pan-y pinch-zoom;
    }

    .world-header:hover {
      background-color: var(--accent-secondary);
    }
    
    .world-header.swiping {
      background-color: var(--danger-color);
      color: white;
      transform: translateX(-100px);
    }
    
    .world-delete-indicator {
      position: absolute;
      right: -80px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--danger-color);
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .world-header.swiping .world-delete-indicator {
      opacity: 1;
    }

    .world-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .world-count {
      font-size: 0.8rem;
      color: var(--text-secondary);
      background-color: var(--bg-primary);
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
    }

    .world-stories {
      margin-left: 0.5rem;
      border-left: 2px solid var(--accent-primary);
      padding-left: 0.5rem;
    }

    .sidebar-story-item {
      padding: 0.6rem 0.8rem;
      margin-bottom: 0.4rem;
      background-color: var(--bg-primary);
      border-radius: 6px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .sidebar-story-item:hover {
      background-color: var(--hover-bg);
      transform: translateX(3px);
    }

    .sidebar-story-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.2rem;
    }

    .sidebar-story-preview {
      font-size: 0.75rem;
      color: var(--text-muted);
      line-height: 1.2;
    }

    .start-story-btn {
      background-color: #F77F00;
      /* Bold warm orange for call to action */
      color: white;
      border: none;
      padding: 0.8rem 1.2rem;
      font-size: 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 1.6rem;
      margin-top: 0.8rem;
      transition: all 0.3s;
      font-family: Arial, sans-serif;
      font-weight: 700;
    }

    .start-story-btn:hover {
      background-color: #FFB703;
      /* Soft golden orange on hover */
      transform: translateY(-2px);
    }

    .start-story-btn.move-out {
      transition: opacity 0.3s, transform 0.3s;
      opacity: 0;
      transform: scale(0.7);
      pointer-events: none;
    }

    .start-story-btn.move-in {
      transition: opacity 0.3s, transform 0.3s;
      opacity: 1;
      transform: scale(1);
    }

    .text-display {
      background-color: transparent;
      border: none;
      border-radius: 0;
      padding: 1.6rem 0;
      min-height: 300px;
      margin-bottom: 1.6rem;
      font-size: 1rem;
      line-height: 1.6;
      color: var(--text-primary);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      transition: color 0.3s ease;
    }

    .text-display.slide-up {
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s;
      transform: translateY(40px);
      opacity: 0;
    }

    .text-display.slide-in {
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s;
      transform: translateY(0);
      opacity: 1;
    }

    /* Markdown content styling */
    .story-content h1,
    .story-content h2,
    .story-content h3 {
      color: var(--accent-primary);
      margin-top: 1.5rem;
      margin-bottom: 0.8rem;
    }

    .story-content p {
      margin-bottom: 1rem;
    }

    .story-content strong {
      font-weight: 700;
      color: var(--text-primary);
    }

    .story-content em {
      font-style: italic;
    }

    .story-content ul,
    .story-content ol {
      margin: 1rem 0;
      padding-left: 2rem;
    }

    .story-content blockquote {
      border-left: 4px solid var(--accent-primary);
      padding-left: 1rem;
      margin: 1rem 0;
      font-style: italic;
      color: var(--text-secondary);
    }

    .story-content code {
      background-color: var(--bg-primary);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: Arial, sans-serif;
    }

    .continue-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--border-color);
      text-align: center;
    }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
      padding: 4rem 2rem;
      font-size: 1.1rem;
    }





    /* Profile Page Styles */
    .profile-container {
      background-color: var(--bg-secondary);
      border-radius: 8px;
      padding: 1.6rem;
      box-shadow: 0 4px 6px var(--shadow-light);
      text-align: center;
    }

    .profile-picture {
      width: 152px;
      height: 152px;
      border-radius: 50%;
      background-color: #90EE90;
      /* Light pastel green background */
      margin: 0 auto 1.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: white;
      border: 4px solid #F77F00;
      /* Bold warm orange border */
    }

    .profile-info h2 {
      color: #2E8B57;
      /* Sea green for headings */
      margin-bottom: 1.6rem;
      font-family: Arial, sans-serif;
      font-weight: 700;
    }

    .profile-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 1.6rem;
      padding-top: 1.6rem;
      border-top: 1px solid #dee2e6;
    }

    .stat {
      text-align: center;
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2E8B57;
      /* Sea green for numbers */
      font-family: Arial, sans-serif;
    }

    .stat-label {
      color: #5A5A5A;
      /* Softer gray for secondary text */
      font-size: 0.9rem;
    }

    .skill-test-btn {
      background-color: #F77F00;
      /* Bold warm orange for call to action */
      color: white;
      border: none;
      padding: 1.6rem 2.4rem;
      font-size: 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 1.6rem;
      transition: all 0.3s;
      font-weight: 700;
      font-family: Arial, sans-serif;
    }

    .skill-test-btn:hover {
      background-color: #FFB703;
      /* Soft golden orange on hover */
      transform: translateY(-2px);
    }

    .clear-worlds-btn {
      background-color: #DC143C;
      /* Bold red for destructive action */
      color: white;
      border: none;
      padding: 1.6rem 2.4rem;
      font-size: 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 1.6rem;
      transition: all 0.3s;
      font-weight: 700;
      font-family: Arial, sans-serif;
    }

    .clear-worlds-btn:hover {
      background-color: #B22222;
      /* Darker red on hover */
      transform: translateY(-2px);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: var(--modal-bg);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      border: 2px solid var(--border-color);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-header h2 {
      margin: 0;
      color: var(--text-color);
      font-size: 1.5em;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .modal-close:hover {
      background-color: var(--hover-bg);
    }

    .modal-body {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-color);
      font-weight: bold;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      background-color: var(--input-bg);
      color: var(--text-color);
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }

    .btn-primary:hover {
      background-color: #45a049;
    }

    .btn-secondary {
      background-color: var(--secondary-btn-bg);
      color: var(--text-color);
      border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
      background-color: var(--hover-bg);
    }

    /* Translation Tooltip Styles */
    .translation-tooltip {
      position: absolute;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--accent-primary);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-family: Arial, sans-serif;
      max-width: 300px;
      word-wrap: break-word;
      z-index: 1000;
      box-shadow: 0 4px 12px var(--shadow-dark);
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
    }

    .translation-tooltip.show {
      opacity: 1;
      transform: translateY(0);
    }

    .translation-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--accent-primary) transparent transparent transparent;
    }

    .translation-original {
      font-weight: 600;
      margin-bottom: 4px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 4px;
    }

    .translation-result {
      font-style: italic;
    }

    .translation-loading {
      color: var(--warning-color);
      font-style: italic;
    }

    /* Highlight selected text */
    .text-selected {
      background-color: var(--selection-bg);
      border-radius: 2px;
    }

    /* Felix Icon */
    .felix-icon {
      position: fixed;
      bottom: 1.6rem;
      right: 1.6rem;
      width: 4.8rem;
      height: 4.8rem;
      background-image: url('static/felixthefox.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border: 2px solid #F77F00;
      border-radius: 50%;
      cursor: pointer;
      transition: right 0.5s cubic-bezier(0.4, 0, 0.2, 1), width 0.5s cubic-bezier(0.4, 0, 0.2, 1), border-radius 0.5s, background-color 0.5s, background-image 0.5s, box-shadow 0.5s;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .felix-icon:hover {
      transform: scale(1.1);
      border-color: #FFB703;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .felix-icon:active {
      transform: scale(0.95);
    }

    .felix-icon.expanded {
      width: 90vw;
      left: 50%;
      transform: translateX(-50%);
      height: 4.8rem;
      border-radius: 2.4rem;
      background-color: white;
      background-image: none;
      border: 2px solid #2E8B57;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .felix-textbox {
      position: fixed;
      bottom: 1.6rem;
      left: 50%;
      width: 90vw;
      height: 4.8rem;
      background-color: white;
      border: 2px solid #2E8B57;
      border-radius: 2.4rem;
      padding: 0 2.4rem;
      font-size: 1rem;
      font-family: Arial, sans-serif;
      color: #1C1C1C;
      outline: none;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      display: none;
      transform: translateX(-50%);
      transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1), width 0.5s cubic-bezier(0.4, 0, 0.2, 1), border-radius 0.5s, box-shadow 0.5s;
    }

    .felix-textbox:focus {
      border-color: #F77F00;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .felix-textbox::placeholder {
      color: #5A5A5A;
      font-style: italic;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .nav-container {
        flex-direction: column;
        gap: 1.6rem;
      }

      .nav-links {
        gap: 1.6rem;
      }

      .main-content {
        padding: 1.6rem;
      }

      .profile-stats {
        flex-direction: column;
        gap: 1.6rem;
      }

      /* Mobile sidebar layout */
      .chat-layout {
        flex-direction: column;
        gap: 1rem;
      }

      .story-sidebar {
        width: 100%;
        max-height: 50vh;
        order: 2;
        /* Put sidebar below main content on mobile */
      }

      .chat-main {
        order: 1;
      }

      .felix-icon {
        width: 4rem;
        height: 4rem;
        bottom: 1.6rem;
        left: 1.6rem;
      }

      .felix-icon.expanded {
        width: 90vw;
        left: 50%;
        transform: translateX(-50%);
        height: 4rem;
        border-radius: 2rem;
      }

      .felix-textbox {
        width: 90vw;
        left: 50%;
        transform: translateX(-50%);
        height: 4rem;
        border-radius: 2rem;
        padding: 0 1.6rem;
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-left">
        <div class="logo">Duolingo 2.0</div>
      </div>
      <div class="nav-center">
        <div class="nav-links">
          <a href="#" class="nav-link active" onclick="showPage('chat')">Chat</a>
          <a href="#" class="nav-link" onclick="showPage('profile')">Profile</a>
        </div>
      </div>
      <div class="nav-right">
        <button class="dark-mode-toggle" onclick="toggleDarkMode()" id="darkModeBtn">
          <span class="icon">☀️</span>
          <span class="text">Light</span>
        </button>
      </div>
    </div>
  </nav>


  <!-- Main Content -->
  <div class="main-content">
    <!-- Chat Page -->
    <div id="chat" class="page active">
      <div class="chat-layout">
        <!-- Left Sidebar for Stories -->
        <div class="story-sidebar">
          <div class="sidebar-actions">
            <button class="sidebar-btn" onclick="handleStoryButton(0, 'new')" id="newStoryBtn">New Story</button>
            <button class="sidebar-btn" onclick="showCreateWorldForm()" id="createWorldBtn">Create World</button>
          </div>

          <h3>Stories by World</h3>
          <div class="world-groups" id="worldGroups">
            <!-- World groups will be populated here -->
          </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
          <div class="chat-container">
            <div class="text-display" id="textDisplay">
              <div class="empty-state">
                <p>Select a story from the sidebar or create a new one to get started!</p>
              </div>
            </div>

            <div class="continue-section" id="continueSection" style="display: none;">
              <button class="start-story-btn" onclick="handleStoryButton(1, -1)" id="continueBtn">Continue</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Page -->
    <div id="profile" class="page">
      <div class="profile-container">
        <div class="profile-picture">
          👤
        </div>
        <div class="profile-info">
          <h2>User Profile</h2>
          <p>Welcome to Duolingo 2.0!</p>
          <button class="skill-test-btn" onclick="showSkillTest()">Take Skill Test</button>
          <button class="clear-worlds-btn" onclick="clearAllWorlds()">Clear All Worlds</button>
        </div>
        <div class="profile-stats">
          <div class="stat">
            <div class="stat-number">12</div>
            <div class="stat-label">Stories Created</div>
          </div>
          <div class="stat">
            <div class="stat-number">5</div>
            <div class="stat-label">Favorites</div>
          </div>
          <div class="stat">
            <div class="stat-number">3</div>
            <div class="stat-label">Days Active</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Skill Test Page -->
    <div id="skill-test" class="page">
      <div class="skill-test-container">
        <div class="skill-test-header">
          <h1>Language Learning Assessment</h1>
          <p>Let's find out what language you'd like to learn and assess your current level!</p>
        </div>

        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 20%"></div>
        </div>

        <div class="question-container">
          <div class="question" id="questionText">What language do you want to learn?</div>
          <div class="options-container" id="optionsContainer">
            <div class="option" onclick="selectOption(this, 'english')">
              <input type="radio" name="language" value="english" id="english">
              <label for="english">English</label>
            </div>
            <div class="option" onclick="selectOption(this, 'french')">
              <input type="radio" name="language" value="french" id="french">
              <label for="french">French</label>
            </div>
            <div class="option" onclick="selectOption(this, 'german')">
              <input type="radio" name="language" value="german" id="german">
              <label for="german">German</label>
            </div>
            <div class="option" onclick="selectOption(this, 'korean')">
              <input type="radio" name="language" value="korean" id="korean">
              <label for="korean">Korean</label>
            </div>
            <div class="option" onclick="selectOption(this, 'chinese (simplified)')">
              <input type="radio" name="language" value="chinese (simplified)" id="chinese (simplified)">
              <label for="chinese (simplified)">Chinese (Simplified)</label>
            </div>
            <div class="option" onclick="selectOption(this, 'spanish')">
              <input type="radio" name="language" value="spanish" id="spanish">
              <label for="spanish">Spanish</label>
            </div>
            <div class="option" onclick="selectOption(this, 'portuguese')">
              <input type="radio" name="language" value="portuguese" id="portuguese">
              <label for="portuguese">Portuguese</label>
            </div>
            <div class="option" onclick="selectOption(this, 'italian')">
              <input type="radio" name="language" value="italian" id="italian">
              <label for="italian">Italian</label>
            </div>
            <div class="option" onclick="selectOption(this, 'japanese')">
              <input type="radio" name="language" value="japanese" id="japanese">
              <label for="japanese">Japanese</label>
            </div>
            <div class="option" onclick="selectOption(this, 'russian')">
              <input type="radio" name="language" value="russian" id="russian">
              <label for="russian">Russian</label>
            </div>
            <div class="option" onclick="selectOption(this, 'arabic')">
              <input type="radio" name="language" value="arabic" id="arabic">
              <label for="arabic">Arabic</label>
            </div>
            <div class="option" onclick="selectOption(this, 'hindi')">
              <input type="radio" name="language" value="hindi" id="hindi">
              <label for="hindi">Hindi</label>
            </div>
          </div>
        </div>

        <div class="test-navigation">
          <button class="btn btn-secondary" onclick="goBackToProfile()">Back to Profile</button>
          <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>Next Question</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create World Modal -->
  <div id="createWorldModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New World</h2>
        <button class="modal-close" onclick="hideCreateWorldForm()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="createWorldForm" onsubmit="createNewWorld(event)">
          <div class="form-group">
            <label for="worldName">World Name:</label>
            <input type="text" id="worldName" name="worldName" required
              placeholder="Enter world name (e.g., 'adventure-realm')" pattern="[a-zA-Z0-9_-]+"
              title="Only letters, numbers, hyphens, and underscores allowed">
          </div>
          <div class="form-group">
            <label for="worldDescription">World Description:</label>
            <textarea id="worldDescription" name="worldDescription" required
              placeholder="Describe this world's setting, characters, and theme..." rows="4"></textarea>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="hideCreateWorldForm()">Cancel</button>
            <button type="submit" class="btn btn-primary">Create World</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Felix the Fox Icon -->
  <div class="felix-icon" id="felixIcon" onclick="handleFelixClick()"></div>
  <input type="text" class="felix-textbox" id="felixTextbox" placeholder="Ask Felix anything..."
    onkeypress="handleFelixInput(event)">

  <script>
    let lastStoryLanguage = 'French';
    let lastStoryFormat = '0'; // Default to play script
    let currentStoryIndex = 0; // Track the current story segment index
    let currentWorldFile = 'data/world0.json'; // Track the current world file
    // Modern Navbar Scroll Effect
    window.addEventListener('scroll', function () {
      const navbar = document.querySelector('.navbar');
      if (window.scrollY > 40) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });


    // Function to get available worlds for selection
    async function getAvailableWorlds() {
      try {
        const response = await fetch('/api/get_all_stories');
        const data = await response.json();
        if (data.success) {
          return data.worlds.map(world => ({
            name: world.name,
            description: world.description
          }));
        }
        return [];
      } catch (error) {
        console.error('Error fetching worlds:', error);
        return [];
      }
    }



    function showNewStoryForm() {
      const textDisplay = document.getElementById('textDisplay');
      const continueSection = document.getElementById('continueSection');

      // Hide continue section
      continueSection.style.display = 'none';

      // Create inline form similar to create world screen
      textDisplay.innerHTML = `
        <div class="create-story-form">
          <h2 style="color: var(--accent-primary); text-align: center; margin-bottom: 2rem;">Create New Story</h2>
          
          <div style="margin: 1.5rem auto 0.5rem auto; text-align: center;">
            <label for="storyWorldInput" style="font-weight:600; font-size:1.1rem; margin-right:0.7rem;">Choose World:</label>
            <select id="storyWorldInput" style="padding:0.7rem 1.2rem; border-radius:12px; border:2px solid #2E8B57; font-size:1.1rem; background:var(--bg-primary); color:var(--text-primary); box-shadow:0 2px 8px rgba(0,0,0,0.07); outline:none; width: 320px; margin-top: 0.5rem;">
              <option value="">Loading worlds...</option>
            </select>
          </div>
          
          <div style="margin: 1rem auto 0.5rem auto; text-align: center;">
            <label for="storyFormatInput" style="font-weight:600; font-size:1.1rem; margin-right:0.7rem;">Story Format:</label>
            <select id="storyFormatInput" style="padding:0.7rem 1.2rem; border-radius:12px; border:2px solid #2E8B57; font-size:1.1rem; background:var(--bg-primary); color:var(--text-primary); box-shadow:0 2px 8px rgba(0,0,0,0.07); outline:none; width: 320px; margin-top: 0.5rem;">
              <option value="0">Play Script</option>
              <option value="1">Short Story</option>
            </select>
          </div>
          
          <div style="margin: 1rem auto 0.5rem auto; text-align: center;">
            <label for="storyLanguageInput" style="font-weight:600; font-size:1.1rem; margin-right:0.7rem;">Language:</label>
            <select id="storyLanguageInput" style="padding:0.7rem 1.2rem; border-radius:12px; border:2px solid #2E8B57; font-size:1.1rem; background:var(--bg-primary); color:var(--text-primary); box-shadow:0 2px 8px rgba(0,0,0,0.07); outline:none; width: 320px; margin-top: 0.5rem;">
              <option value="French">French</option>
              <option value="English">English</option>
              <option value="German">German</option>
              <option value="Korean">Korean</option>
              <option value="Chinese (Simplified)">Chinese (Simplified)</option>
              <option value="Spanish">Spanish</option>
              <option value="Portuguese">Portuguese</option>
              <option value="Italian">Italian</option>
              <option value="Japanese">Japanese</option>
              <option value="Russian">Russian</option>
              <option value="Arabic">Arabic</option>
              <option value="Hindi">Hindi</option>
            </select>
          </div>
          
          <div style="margin: 1rem auto 0.5rem auto; text-align: center;">
            <label for="storyPromptInput" style="font-weight:600; font-size:1.1rem; margin-right:0.7rem;">Story Prompt:</label>
            <textarea id="storyPromptInput" placeholder="Describe your story idea..." 
                      style="padding:0.7rem 1.2rem; border-radius:12px; border:2px solid #2E8B57; font-size:1.1rem; background:var(--bg-primary); color:var(--text-primary); box-shadow:0 2px 8px rgba(0,0,0,0.07); outline:none; width: 320px; height: 100px; margin-top: 0.5rem; resize: vertical; font-family: inherit;"
                      rows="4"></textarea>
          </div>
          
          <div style="margin: 2rem auto; text-align: center; display: flex; gap: 1rem; justify-content: center;">
            <button onclick="cancelNewStory()" style="padding:0.8rem 2rem; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-secondary); color:var(--text-primary); cursor:pointer; font-size:1rem; font-weight:600;">Cancel</button>
            <button onclick="submitNewStory()" style="padding:0.8rem 2rem; border-radius:8px; border:none; background:var(--accent-primary); color:white; cursor:pointer; font-size:1rem; font-weight:600;">Create Story</button>
          </div>
        </div>
      `;

      // Load available worlds and populate dropdown
      getAvailableWorlds().then(worlds => {
        const worldDropdown = document.getElementById('storyWorldInput');
        if (worldDropdown) {
          worldDropdown.innerHTML = '';
          if (worlds.length === 0) {
            worldDropdown.innerHTML = '<option value="">No worlds available - Create one first!</option>';
          } else {
            worlds.forEach(world => {
              const option = document.createElement('option');
              option.value = world.name;
              option.textContent = `${world.name} - ${world.description}`;
              worldDropdown.appendChild(option);
            });
          }
        }
      });

      // Focus on the prompt input
      setTimeout(() => {
        document.getElementById('storyPromptInput').focus();
      }, 100);
    }

    function cancelNewStory() {
      const textDisplay = document.getElementById('textDisplay');
      textDisplay.innerHTML = `
        <div class="empty-state">
          <p>Select a story from the sidebar or create a new one to get started!</p>
        </div>
      `;
    }

    function submitNewStory() {
      const worldName = document.getElementById('storyWorldInput').value.trim();
      const format = document.getElementById('storyFormatInput').value;
      const language = document.getElementById('storyLanguageInput').value;
      const prompt = document.getElementById('storyPromptInput').value.trim();

      if (!worldName) {
        alert('Please select a world first!');
        return;
      }

      if (!prompt) {
        alert('Please enter a story prompt.');
        return;
      }

      // Call handleStoryButton with the form data
      handleStoryButton(0, { prompt, language, format, worldName });
    }



    // Page Navigation
    function showPage(pageId) {
      // Hide all pages
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.classList.remove('active'));

      // Remove active class from all nav links
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => link.classList.remove('active'));

      // Show selected page
      document.getElementById(pageId).classList.add('active');

      // Add active class to clicked nav link
      event.target.classList.add('active');

      // Felix visibility logic
      const felixIcon = document.getElementById('felixIcon');
      const felixTextbox = document.getElementById('felixTextbox');
      if (pageId === 'profile') {
        felixIcon.style.display = 'none';
        felixTextbox.style.display = 'none';
        felixTextbox.value = '';
        isExpanded = false;
      } else {
        felixIcon.style.display = 'block';
      }
    }

    // Story Generation Functions
    function handleStoryButton(btnIndex, content_index) {
      const textDisplay = document.getElementById('textDisplay');
      const buttons = document.querySelectorAll('.start-story-btn');
      buttons.forEach(btn => btn.classList.remove('move-in'));

      // If new story, show the inline form
      if (content_index === 'new') {
        showNewStoryForm();
        return;
      }

      // Continue story or handle completion callback from form
      if (typeof content_index === 'object' && content_index.prompt) {
        const { prompt, language, format, worldName } = content_index;
        // Now run the main story logic with collected variables
        textDisplay.innerHTML = '<p>Generating your story... Please wait!</p>';
        textDisplay.classList.remove('slide-in');
        textDisplay.classList.remove('slide-up');
        fetch('/api/generate_story', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            topic: prompt || 'adventure',
            language: language,
            format: format || '0',
            world_file: `data/${worldName}.json`,
            current_content_idx: 'new'
          })
        })
          .then(response => response.text())
          .then(async (data) => {
            lastStoryLanguage = language; // Save the language for future continues
            lastStoryFormat = format; // Save the format for future continues
            currentWorldFile = `data/${worldName}.json`; // Save the world file

            // Get current world stories count to set proper index
            try {
              const response = await fetch('/api/get_all_stories');
              const storiesData = await response.json();
              if (storiesData.success) {
                const currentWorld = storiesData.worlds.find(world => world.name === worldName);
                if (currentWorld && currentWorld.stories) {
                  currentStoryIndex = Math.max(0, currentWorld.stories.length - 1);
                } else {
                  currentStoryIndex = 0;
                }
              } else {
                currentStoryIndex = 0;
              }
            } catch (error) {
              console.error('Error getting world stories count:', error);
              currentStoryIndex = 0;
            }

            console.log('Generated story:', data);
            textDisplay.classList.add('slide-up');
            setTimeout(() => {
              textDisplay.innerHTML = `<div class="story-content">${marked.parse(data)}</div>`;
              textDisplay.classList.remove('slide-up');
              textDisplay.classList.add('slide-in');
            }, 400);
            // Show continue section when content is displayed
            const continueSection = document.getElementById('continueSection');
            continueSection.style.display = 'block';
            addToPreviousStories(data);
          })
          .catch(async error => {
            let errorMsg = 'Error generating story:';
            if (error instanceof Response) {
              try {
                const errJson = await error.json();
                errorMsg += ' ' + (errJson.error || JSON.stringify(errJson));
              } catch (e) {
                try {
                  const errText = await error.text();
                  errorMsg += ' ' + errText;
                } catch (e2) {
                  errorMsg += ' ' + error.statusText;
                }
              }
            } else if (error && error.message) {
              errorMsg += ' ' + error.message;
            } else {
              errorMsg += ' ' + error;
            }
            console.error(errorMsg);
            textDisplay.innerHTML = `<p>${errorMsg}</p>`;
          });
      } else {
        // Continue logic: run story generation directly
        // Check if there's existing content, and if so, add loading indicator differently
        const existingStoryContent = textDisplay.querySelector('.story-content');
        if (existingStoryContent) {
          // Add a loading indicator within the existing content
          const loadingEl = document.createElement('p');
          loadingEl.id = 'story-loading';
          loadingEl.textContent = 'Generating more story... Please wait!';
          loadingEl.style.fontStyle = 'italic';
          loadingEl.style.color = 'var(--text-muted)';
          existingStoryContent.appendChild(loadingEl);
        } else {
          // No existing content, show normal loading message
          textDisplay.innerHTML = '<p>Generating your story... Please wait!</p>';
        }
        textDisplay.classList.remove('slide-in');
        textDisplay.classList.remove('slide-up');
        console.log("Current Story Index:", currentStoryIndex);
        fetch('/api/generate_story', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            topic: 'adventure', // or previous topic
            language: lastStoryLanguage, // use last story's language
            format: lastStoryFormat, // use last story's format
            world_file: currentWorldFile, // use current world file
            current_content_idx: currentStoryIndex
          })
        })
          .then(response => response.text())
          .then(data => {
            console.log('Generated story:', data);
            textDisplay.classList.add('slide-up');
            setTimeout(() => {
              // Remove loading indicator if it exists
              const loadingEl = document.getElementById('story-loading');
              if (loadingEl) {
                loadingEl.remove();
              }

              // Check if there's existing story content to append to
              const existingStoryContent = textDisplay.querySelector('.story-content');
              if (existingStoryContent) {
                // Append new content to existing story
                const newContent = marked.parse(data);
                existingStoryContent.innerHTML += newContent;
              } else {
                // No existing content, create new story content
                textDisplay.innerHTML = `<div class="story-content">${marked.parse(data)}</div>`;
              }
              textDisplay.classList.remove('slide-up');
              textDisplay.classList.add('slide-in');
            }, 400);
            // Show continue section when content is displayed
            const continueSection = document.getElementById('continueSection');
            continueSection.style.display = 'block';
            addToPreviousStories(data);
            const continueBtn = buttons[1];
            if (continueBtn) {
              continueBtn.classList.add('move-out');
              setTimeout(() => {
                continueBtn.classList.remove('move-out');
                const previousStories = document.querySelector('.previous-stories');
                if (previousStories) {
                  previousStories.parentNode.insertBefore(continueBtn, previousStories);
                }
                setTimeout(() => {
                  continueBtn.classList.add('move-in');
                }, 10);
              }, 300);
            }
          })
          .catch(async error => {
            let errorMsg = 'Error generating story:';
            if (error instanceof Response) {
              try {
                const errJson = await error.json();
                errorMsg += ' ' + (errJson.error || JSON.stringify(errJson));
              } catch (e) {
                try {
                  const errText = await error.text();
                  errorMsg += ' ' + errText;
                } catch (e2) {
                  errorMsg += ' ' + error.statusText;
                }
              }
            } else if (error && error.message) {
              errorMsg += ' ' + error.message;
            } else {
              errorMsg += ' ' + error;
            }
            console.error(errorMsg);
            // Remove loading indicator if it exists
            const loadingEl = document.getElementById('story-loading');
            if (loadingEl) {
              loadingEl.remove();
            }
            // For continue errors, append error message instead of replacing content
            const existingStoryContent = textDisplay.querySelector('.story-content');
            if (existingStoryContent) {
              const errorEl = document.createElement('p');
              errorEl.style.color = 'var(--error-color, #ff6b6b)';
              errorEl.textContent = errorMsg;
              existingStoryContent.appendChild(errorEl);
            } else {
              textDisplay.innerHTML = `<p>${errorMsg}</p>`;
            }
          });
      }

      // Only clear previous story text for new stories, not continues
      if (content_index === 'new' || (typeof content_index === 'object' && content_index.prompt)) {
        textDisplay.innerHTML = '';
      }

      // All felixInput UI logic is handled inside newStoryFelix
    }

    function continueStory() {
      const continueBtn = document.querySelectorAll('.start-story-btn')[1];
      if (continueBtn) {
        continueBtn.classList.add('move-out');
        setTimeout(() => {
          continueBtn.classList.remove('move-out');
          const previousStories = document.querySelector('.previous-stories');
          if (previousStories) {
            previousStories.parentNode.insertBefore(continueBtn, previousStories);
          }
          // Animate in
          setTimeout(() => {
            continueBtn.classList.add('move-in');
          }, 10);
        }, 300);
      }
    }

    function addToPreviousStories(story) {
      // Refresh the sidebar to show the newly created story
      // The story should already be saved to the world file by the backend
      setTimeout(() => {
        loadAllStories();
      }, 500); // Small delay to ensure backend has saved the story
    }

    // Skill Test Functions
    function showSkillTest() {
      // Hide all pages
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.classList.remove('active'));

      // Show skill test page
      document.getElementById('skill-test').classList.add('active');

      // Reset the test
      resetSkillTest();
    }

    function goBackToProfile() {
      // Hide all pages
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.classList.remove('active'));

      // Show profile page
      document.getElementById('profile').classList.add('active');
    }

    async function clearAllWorlds() {
      // Show confirmation dialog
      const confirmClear = confirm('Are you sure you want to clear all world data? This action cannot be undone.');

      if (!confirmClear) {
        return;
      }

      try {
        const response = await fetch('/api/clear_worlds', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const result = await response.json();

        if (result.success) {
          alert(`Success! ${result.message}\nCleared worlds: ${result.cleared_worlds.join(', ')}`);
          // Refresh the sidebar to show empty state
          loadAllStories();
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        console.error('Error clearing worlds:', error);
        alert('Failed to clear worlds. Please check the console for more details.');
      }
    }

    function showCreateWorldForm() {
      const textDisplay = document.getElementById('textDisplay');
      const continueSection = document.getElementById('continueSection');

      // Hide continue section
      continueSection.style.display = 'none';

      // Create inline form similar to new story screen
      textDisplay.innerHTML = `
        <div class="create-world-form">
          <h2 style="color: var(--accent-primary); text-align: center; margin-bottom: 2rem;">Create New World</h2>
          
          <div style="margin: 1.5rem auto 0.5rem auto; text-align: center;">
            <label for="worldNameInput" style="font-weight:600; font-size:1.1rem; margin-right:0.7rem;">World Name:</label>
            <input type="text" id="worldNameInput" placeholder="Enter world name (e.g., 'adventure-realm')" 
                   style="padding:0.7rem 1.2rem; border-radius:12px; border:2px solid #2E8B57; font-size:1.1rem; background:var(--bg-primary); color:var(--text-primary); box-shadow:0 2px 8px rgba(0,0,0,0.07); outline:none; width: 300px; margin-top: 0.5rem;"
                   pattern="[a-zA-Z0-9_-]+" title="Only letters, numbers, hyphens, and underscores allowed">
          </div>
          
          <div style="margin: 1rem auto 0.5rem auto; text-align: center;">
            <label for="worldDescInput" style="font-weight:600; font-size:1.1rem; margin-right:0.7rem;">Description:</label>
            <textarea id="worldDescInput" placeholder="Describe this world's setting, characters, and theme..." 
                      style="padding:0.7rem 1.2rem; border-radius:12px; border:2px solid #2E8B57; font-size:1.1rem; background:var(--bg-primary); color:var(--text-primary); box-shadow:0 2px 8px rgba(0,0,0,0.07); outline:none; width: 300px; height: 100px; margin-top: 0.5rem; resize: vertical; font-family: inherit;"
                      rows="4"></textarea>
          </div>
          
          <div style="margin: 2rem auto; text-align: center; display: flex; gap: 1rem; justify-content: center;">
            <button onclick="cancelCreateWorld()" style="padding:0.8rem 2rem; border-radius:8px; border:2px solid var(--border-color); background:var(--bg-secondary); color:var(--text-primary); cursor:pointer; font-size:1rem; font-weight:600;">Cancel</button>
            <button onclick="submitCreateWorld()" style="padding:0.8rem 2rem; border-radius:8px; border:none; background:var(--accent-primary); color:white; cursor:pointer; font-size:1rem; font-weight:600;">Create World</button>
          </div>
        </div>
      `;

      // Focus on the name input
      setTimeout(() => {
        document.getElementById('worldNameInput').focus();
      }, 100);
    }

    function cancelCreateWorld() {
      const textDisplay = document.getElementById('textDisplay');
      textDisplay.innerHTML = `
        <div class="empty-state">
          <p>Select a story from the sidebar or create a new one to get started!</p>
        </div>
      `;
    }

    function submitCreateWorld() {
      const worldName = document.getElementById('worldNameInput').value.trim();
      const worldDescription = document.getElementById('worldDescInput').value.trim();

      if (!worldName || !worldDescription) {
        alert('Please fill in both world name and description.');
        return;
      }

      // Validate world name format
      const validNameRegex = /^[a-zA-Z0-9_-]+$/;
      if (!validNameRegex.test(worldName)) {
        alert('World name can only contain letters, numbers, hyphens, and underscores.');
        return;
      }

      createNewWorld(null, worldName, worldDescription);
    }

    async function createNewWorld(event, nameOverride, descOverride) {
      if (event) event.preventDefault();

      const worldName = nameOverride || document.getElementById('worldName')?.value.trim();
      const worldDescription = descOverride || document.getElementById('worldDescription')?.value.trim();

      if (!worldName || !worldDescription) {
        alert('Please fill in both world name and description.');
        return;
      }

      // Validate world name format
      const validNameRegex = /^[a-zA-Z0-9_-]+$/;
      if (!validNameRegex.test(worldName)) {
        alert('World name can only contain letters, numbers, hyphens, and underscores.');
        return;
      }

      try {
        const response = await fetch('/api/create_world', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: worldName,
            description: worldDescription
          })
        });

        const result = await response.json();

        if (result.success) {
          alert(`Success! World "${worldName}" has been created.`);
          cancelCreateWorld(); // Return to empty state
          // Refresh the stories list to include the new world
          loadAllStories();
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        console.error('Error creating world:', error);
        alert('Failed to create world. Please check the console for more details.');
      }
    }

    async function deleteWorld(worldName) {
      try {
        const response = await fetch('/api/delete_world', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: worldName
          })
        });

        const result = await response.json();

        if (result.success) {
          loadAllStories(); // Refresh the list
          const textDisplay = document.getElementById('textDisplay');
          textDisplay.innerHTML = `<div class="empty-state"><p>Select a story from the sidebar or create a new one to get started!</p></div>`;
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        console.error('Error deleting world:', error);
        alert('Failed to delete world. Please check the console for more details.');
      }
    }

    async function loadAllStories() {
      try {
        const response = await fetch('/api/get_all_stories');
        const data = await response.json();

        if (data.success) {
          const worldGroups = document.getElementById('worldGroups');
          worldGroups.innerHTML = ''; // Clear existing content

          // Group stories by world
          data.worlds.forEach(world => {
            const worldGroup = document.createElement('div');
            worldGroup.className = 'world-group';

            // Create world header
            const worldHeader = document.createElement('div');
            worldHeader.className = 'world-header';
            
            const storyCount = world.stories ? world.stories.length : 0;
            worldHeader.innerHTML = `
              <div class="world-name">${world.name}</div>
              <div class="world-count">${storyCount} stories</div>
              <div class="world-delete-indicator">Delete</div>
            `;

            // Add swipe to delete functionality
            let startX = 0;
            let currentX = 0;
            let isDragging = false;

            worldHeader.addEventListener('mousedown', handleDragStart);
            worldHeader.addEventListener('touchstart', handleDragStart);
            
            worldHeader.addEventListener('mousemove', handleDragMove);
            worldHeader.addEventListener('touchmove', handleDragMove);
            
            worldHeader.addEventListener('mouseup', handleDragEnd);
            worldHeader.addEventListener('touchend', handleDragEnd);
            worldHeader.addEventListener('mouseleave', handleDragEnd);

            function handleDragStart(e) {
              isDragging = true;
              startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
              currentX = startX;
            }

            function handleDragMove(e) {
              if (!isDragging) return;
              
              const x = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
              const diff = x - startX;
              
              // Only allow dragging left (negative diff)
              if (diff < 0 && diff > -150) {
                currentX = x;
                const transform = diff;
                worldHeader.style.transform = `translateX(${transform}px)`;
                
                if (transform < -50) {
                  worldHeader.classList.add('swiping');
                } else {
                  worldHeader.classList.remove('swiping');
                }
              }
              
              // Prevent scrolling while dragging
              e.preventDefault();
            }

            function handleDragEnd(e) {
              if (!isDragging) return;
              isDragging = false;
              
              const diff = currentX - startX;
              
              if (diff < -50) {
                // Show confirmation dialog
                if (confirm(`Are you sure you want to delete the world "${world.name}"? This action cannot be undone.`)) {
                  deleteWorld(world.name);
                } else {
                  // Reset position if user cancels
                  worldHeader.style.transform = '';
                  worldHeader.classList.remove('swiping');
                }
              } else {
                // Reset position if not dragged far enough
                worldHeader.style.transform = '';
                worldHeader.classList.remove('swiping');
                
                // If it was a small drag, treat it as a click
                if (Math.abs(diff) < 5) {
                  toggleWorldGroup(world.name);
                }
              }
            };

            worldGroup.appendChild(worldHeader);

            // Create stories container
            const worldStories = document.createElement('div');
            worldStories.className = 'world-stories';
            worldStories.id = `world-${world.name}`;
            worldStories.style.display = 'block'; // Start expanded

            if (world.stories && world.stories.length > 0) {
              world.stories.forEach((story, index) => {
                const storyItem = document.createElement('div');
                storyItem.className = 'sidebar-story-item';
                storyItem.onclick = () => displayStory(story.content, world.name, story.story_index);

                storyItem.innerHTML = `
                  <div class="sidebar-story-title">${story.title}</div>
                  <div class="sidebar-story-preview">${story.preview}</div>
                `;

                worldStories.appendChild(storyItem);
              });
            } else {
              const emptyMessage = document.createElement('div');
              emptyMessage.className = 'sidebar-story-item';
              emptyMessage.style.fontStyle = 'italic';
              emptyMessage.style.color = 'var(--text-muted)';
              emptyMessage.textContent = 'No stories yet';
              worldStories.appendChild(emptyMessage);
            }

            worldGroup.appendChild(worldStories);
            worldGroups.appendChild(worldGroup);
          });

          // If no worlds exist, show a message
          if (data.worlds.length === 0) {
            worldGroups.innerHTML = `
              <div style="text-align: center; color: var(--text-muted); font-style: italic; padding: 2rem;">
                No worlds found.<br>Create your first world to get started!
              </div>
            `;
          }
        } else {
          console.error('Failed to load stories:', data.error);
        }
      } catch (error) {
        console.error('Error loading stories:', error);
      }
    }

    function toggleWorldGroup(worldName) {
      const worldStories = document.getElementById(`world-${worldName}`);
      if (worldStories) {
        if (worldStories.style.display === 'none') {
          worldStories.style.display = 'block';
        } else {
          worldStories.style.display = 'none';
        }
      }
    }

    function displayStory(storyContent, worldName, storyIndex) {
      console.log("Story Idx:" + storyIndex);
      const textDisplay = document.getElementById('textDisplay');
      const continueSection = document.getElementById('continueSection');

      // Render markdown content
      const renderedMarkdown = marked.parse(storyContent);
      textDisplay.innerHTML = `<div class="story-content">${renderedMarkdown}</div>`;

      // Show continue button when content is displayed
      continueSection.style.display = 'block';      // Add some visual feedback
      textDisplay.classList.remove('slide-in');
      textDisplay.classList.add('slide-up');
      setTimeout(() => {
        textDisplay.classList.remove('slide-up');
        textDisplay.classList.add('slide-in');
      }, 100);
    }



    function selectOption(optionElement, value) {
      // Remove selected class from all options
      const options = document.querySelectorAll('.option');
      options.forEach(option => option.classList.remove('selected'));

      // Add selected class to clicked option
      optionElement.classList.add('selected');

      // Check the radio button
      const radioButton = optionElement.querySelector('input[type="radio"]');
      radioButton.checked = true;

      // Enable next button
      document.getElementById('nextBtn').disabled = false;
    }

    // Skill test data
    const skillTestQuestions = [
      {
        question: "What language do you want to learn?",
        options: [
          { value: "english", label: "English" },
          { value: "french", label: "French" },
          { value: "german", label: "German" }
        ]
      },
      {
        question: "What is your current level in this language?",
        options: [
          { value: "beginner", label: "Beginner - I know very little or nothing" },
          { value: "elementary", label: "Elementary - I know some basic words and phrases" },
          { value: "intermediate", label: "Intermediate - I can have simple conversations" },
          { value: "advanced", label: "Advanced - I can communicate fluently" }
        ]
      }
    ];

    let currentQuestionIndex = 0;
    let userAnswers = {};

    function nextQuestion() {
      // Save the current answer
      const selectedOption = document.querySelector('input[name="language"]:checked');
      if (selectedOption) {
        userAnswers[`question_${currentQuestionIndex}`] = selectedOption.value;
      }

      // Move to next question
      currentQuestionIndex++;

      if (currentQuestionIndex < skillTestQuestions.length) {
        loadQuestion(currentQuestionIndex);
      } else {
        // Test completed
        showTestResults();
      }
    }

    function loadQuestion(questionIndex) {
      const question = skillTestQuestions[questionIndex];

      // Update question text
      document.getElementById('questionText').textContent = question.question;

      // Update options
      const optionsContainer = document.getElementById('optionsContainer');
      optionsContainer.innerHTML = '';

      question.options.forEach((option, index) => {
        const optionElement = document.createElement('div');
        optionElement.className = 'option';
        optionElement.onclick = () => selectOption(optionElement, option.value);

        optionElement.innerHTML = `
                    <input type="radio" name="language" value="${option.value}" id="option_${index}">
                    <label for="option_${index}">${option.label}</label>
                `;

        optionsContainer.appendChild(optionElement);
      });

      // Update progress bar
      const progress = ((questionIndex + 1) / skillTestQuestions.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';

      // Reset selection state
      document.getElementById('nextBtn').disabled = true;
    }

    function showTestResults() {
      // Show completion message with user's answers
      const selectedLanguage = userAnswers.question_0;
      const selectedLevel = userAnswers.question_1;

      alert(`Test completed! You selected ${selectedLanguage} at ${selectedLevel} level. This information will be used to personalize your learning experience.`);

      // Go back to profile
      goBackToProfile();
    }

    function resetSkillTest() {
      // Reset question index and answers
      currentQuestionIndex = 0;
      userAnswers = {};

      // Load the first question
      loadQuestion(0);
    }

    // Felix Icon Functionality
    let isExpanded = false;
    let outsideClickListener = null;

    function collapseFelix() {
      const felixIcon = document.getElementById('felixIcon');
      const felixTextbox = document.getElementById('felixTextbox');
      felixIcon.classList.remove('expanded');
      felixIcon.style.opacity = '1';
      felixTextbox.style.opacity = '0';
      setTimeout(() => {
        felixTextbox.style.display = 'none';
        felixTextbox.value = '';
      }, 400);
      isExpanded = false;
      if (outsideClickListener) {
        document.removeEventListener('mousedown', outsideClickListener);
        outsideClickListener = null;
      }
    }

    function handleFelixClick() {
      const felixIcon = document.getElementById('felixIcon');
      const felixTextbox = document.getElementById('felixTextbox');
      if (!isExpanded) {
        felixIcon.classList.add('expanded');
        setTimeout(() => {
          felixIcon.style.opacity = '0';
          felixTextbox.style.display = 'block';
          felixTextbox.style.opacity = '1';
          felixTextbox.focus();
        }, 300); // Wait for animation
        isExpanded = true;
        // Add outside click listener
        outsideClickListener = function (event) {
          if (isExpanded && !felixTextbox.contains(event.target) && event.target !== felixIcon) {
            collapseFelix();
          }
        };
        document.addEventListener('mousedown', outsideClickListener);
      } else {
        collapseFelix();
      }
    }

    function handleFelixInput(event) {
      if (event.key === 'Enter') {
        const userInput = event.target.value.trim();
        if (userInput) {
          console.log('User asked Felix:', userInput);
          // You can add response logic here
          alert(`Felix says: "Thanks for asking: ${userInput}" 🦊`);
          // Clear input and collapse
          event.target.value = '';
          collapseFelix();
        }
      } else if (event.key === 'Escape') {
        // Collapse on escape
        collapseFelix();
      }
    }

    // Text Translation Functionality
    let translationTooltip = null;

    function createTranslationTooltip() {
      if (!translationTooltip) {
        translationTooltip = document.createElement('div');
        translationTooltip.className = 'translation-tooltip';
        document.body.appendChild(translationTooltip);
      }
      return translationTooltip;
    }

    function showTranslationTooltip(text, x, y) {
      const tooltip = createTranslationTooltip();

      // Show loading state
      tooltip.innerHTML = `
        <div class="translation-original">${text}</div>
        <div class="translation-loading">Translating...</div>
      `;

      // Position tooltip
      tooltip.style.left = `${x}px`;
      tooltip.style.top = `${y - 60}px`; // Position above the selection
      tooltip.classList.add('show');

      // Call translation API
      translateText(text).then(translation => {
        if (translation.success) {
          let tooltipContent = `
            <div class="translation-original">${text}</div>
            <div class="translation-result">${translation.translated_text}</div>
          `;

          // Add language detection info if available
          if (translation.source_language && translation.source_language !== 'auto') {
            tooltipContent += `<div style="font-size: 0.8rem; color: #ccc; margin-top: 4px;">Detected: ${translation.source_language.toUpperCase()}</div>`;
          }

          // Add alternative translations if available
          if (translation.additional_translations && translation.additional_translations.length > 0) {
            const alternatives = translation.additional_translations.slice(0, 3).join(', ');
            tooltipContent += `<div style="font-size: 0.8rem; color: #ccc; margin-top: 4px;">Also: ${alternatives}</div>`;
          }

          tooltip.innerHTML = tooltipContent;
        } else {
          tooltip.innerHTML = `
            <div class="translation-original">${text}</div>
            <div style="color: #ff6b6b;">Translation failed</div>
          `;
        }
      }).catch(error => {
        console.error('Translation error:', error);
        tooltip.innerHTML = `
          <div class="translation-original">${text}</div>
          <div style="color: #ff6b6b;">Translation error</div>
        `;
      });
    }

    function hideTranslationTooltip() {
      if (translationTooltip) {
        translationTooltip.classList.remove('show');
      }
    }

    async function translateText(text) {
      try {
        const response = await fetch('/api/translate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: text,
            source: 'auto',
            target: 'en'
          })
        });

        return await response.json();
      } catch (error) {
        console.error('Translation request failed:', error);
        return { success: false, error: error.message };
      }
    }

    // Handle text selection
    document.addEventListener('mouseup', function (event) {
      // Small delay to ensure selection is complete
      setTimeout(() => {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();

        if (selectedText && selectedText.length > 1) {
          // Get selection coordinates
          const range = selection.getRangeAt(0);
          const rect = range.getBoundingClientRect();
          const x = rect.left + (rect.width / 2);
          const y = rect.top + window.scrollY;

          // Show translation tooltip
          showTranslationTooltip(selectedText, x, y);
        } else {
          hideTranslationTooltip();
        }
      }, 10);
    });

    // Hide tooltip when clicking elsewhere
    document.addEventListener('click', function (event) {
      if (!event.target.closest('.translation-tooltip')) {
        hideTranslationTooltip();
      }
    });

    // Hide tooltip when pressing escape
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        hideTranslationTooltip();
      }
    });

    // Dark Mode Functionality
    function toggleDarkMode() {
      const html = document.documentElement;
      const toggleButton = document.querySelector('.dark-mode-toggle');
      const icon = toggleButton.querySelector('.icon');
      const text = toggleButton.querySelector('.text');

      if (html.getAttribute('data-theme') === 'dark') {
        // Switch to light mode
        html.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
        // Show current state (now light mode)
        icon.textContent = '☀️';
        text.textContent = 'Light';
      } else {
        // Switch to dark mode
        html.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        // Show current state (now dark mode)
        icon.textContent = '🌙';
        text.textContent = 'Dark';
      }
    }

    // Initialize theme on page load
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme');
      const html = document.documentElement;
      const toggleButton = document.querySelector('.dark-mode-toggle');

      if (toggleButton) {
        const icon = toggleButton.querySelector('.icon');
        const text = toggleButton.querySelector('.text');

        if (savedTheme === 'dark') {
          html.setAttribute('data-theme', 'dark');
          // Show current state (dark mode)
          icon.textContent = '🌙';
          text.textContent = 'Dark';
        } else {
          html.removeAttribute('data-theme');
          // Show current state (light mode)
          icon.textContent = '☀️';
          text.textContent = 'Light';
        }
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Duolingo2.0 loaded successfully!');
      initializeTheme();
      loadAllStories();
    });
  </script>
</body>

</html>